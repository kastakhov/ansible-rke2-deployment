apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  namespace: kube-system
  name: argo-cd
spec:
  targetNamespace: argocd
  createNamespace: true
  version: {{ ARGOCD_VERSION }}
  chart: argo-cd
  repo: https://argoproj.github.io/argo-helm
  valuesContent: |-
    redis-ha:
      enabled: true
    controller:
      replicas: 1
    server:
      autoscaling:
        enabled: true
        minReplicas: 2
    repoServer:
      autoscaling:
        enabled: true
        minReplicas: 2
    applicationSet:
      replicas: 2

    global:
      domain: argocd-{{ DEPLOYMENT_ENV }}-{{ DEPLOYMENT_ID }}.{{ EXTERNAL_DOMAIN }}

    certificate:
      enabled: true

    server:
      ingress:
        enabled: true
        ingressClassName: nginx
        annotations:
          nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
          nginx.ingress.kubernetes.io/ssl-passthrough: "true"
        tls: true

    configs:
      cmp:
        create: true
        plugins:
          argocd-vault-plugin-jsonnet:
            allowConcurrency: true
            discover:
              find:
                command:
                  - find
                  - "."
                  - -name
                  - *.json
            generate:
              command:
                - sh
                - "-c"
                - "jsonnet . | argocd-vault-plugin generate -"
            lockRepo: false
           argocd-vault-plugin-kustomize:
            allowConcurrency: true
            # Note: this command is run _before_ anything is done, therefore the logic is to check
            # if this looks like a Kustomize bundle
            discover:
              find:
                command:
                  - find
                  - "."
                  - -name
                  - kustomization.yaml
            generate:
              command:
                - sh
                - "-c"
                - "kustomize build . | argocd-vault-plugin generate -"
            lockRepo: false
          argocd-vault-plugin-helm:
            allowConcurrency: true
            # Note: this command is run _before_ any Helm templating is done, therefore the logic is to check
            # if this looks like a Helm chart
            discover:
              find:
                command:
                  - sh
                  - "-c"
                  - "find . -name 'Chart.yaml' && find . -name 'values.yaml'"
            generate:
              # **IMPORTANT**: passing `${ARGOCD_ENV_HELM_ARGS}` effectively allows users to run arbitrary code in the Argo CD 
              # repo-server (or, if using a sidecar, in the plugin sidecar). Only use this when the users are completely trusted. If
              # possible, determine which Helm arguments are needed by your users and explicitly pass only those arguments.
              command:
                - sh
                - "-c"
                - |
                  helm template $ARGOCD_APP_NAME -n $ARGOCD_APP_NAMESPACE ${ARGOCD_ENV_HELM_ARGS} . |
                  argocd-vault-plugin generate -
            lockRepo: false
          argocd-vault-plugin:
            allowConcurrency: true
            discover:
              find:
                command:
                  - sh
                  - "-c"
                  - "find . -name '*.yaml' | xargs -I {} grep \"<path\\|avp\\.kubernetes\\.io\" {} | grep ."
            generate:
              command:
                - argocd-vault-plugin
                - generate
                - "."
            lockRepo: false
